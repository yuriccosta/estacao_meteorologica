<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estação Meteorológica</title>
    <!-- Biblioteca de Gráficos ApexCharts -->
    <script src='https://cdn.jsdelivr.net/npm/apexcharts'></script>
    <style>
        /* Estilos Globais Otimizados */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 10px;
        }
        .container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }
        header { text-align: center; margin-bottom: 20px; }
        h1 { font-size: 1.5rem; color: #58a6ff; margin: 0; }
        p { margin: 4px 0 0; color: #8b949e; }

        /* Layout Flexbox */
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .panel {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            flex: 1;
            min-width: 300px; /* Garante que não fiquem muito espremidos */
        }
        .panel-title {
            font-size: 1.1rem;
            color: #58a6ff;
            margin: 0 0 15px 0;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
        }

        /* Cards de Leitura */
        .sensor-group { margin-bottom: 15px; }
        .sensor-group-title { font-size: 0.9rem; color: #8b949e; margin-bottom: 10px; }
        .readings-grid {
            display: flex;
            gap: 10px;
        }
        .reading-card {
            background-color: #0d1117;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            flex: 1;
        }
        .reading-card .label { font-size: 0.8rem; color: #8b949e; }
        .reading-card .value { font-size: 1.2rem; font-weight: 600; color: #c9d1d9; }

        /* Formulário Otimizado */
        .form-group { margin-bottom: 10px; }
        .form-group label {
            display: block;
            font-size: 0.8rem;
            color: #8b949e;
            margin-bottom: 4px;
        }
        .input-row { display: flex; gap: 10px; }
        .input-row input {
            width: 100%;
            background-color: #010409;
            border: 1px solid #30363d;
            color: #c9d1d9;
            border-radius: 6px;
            padding: 8px;
            font-size: 0.9rem;
        }
        .btn-submit {
            width: 100%;
            background-color: #238636;
            color: #ffffff;
            border: 1px solid #2ea043;
            padding: 10px;
            font-size: 1rem;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
        }
        #notification {
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            margin-top: 10px;
            font-weight: 600;
            display: none;
        }
        #notification.success { background-color: #238636; }
        #notification.error { background-color: #da3633; }

        /* Gráfico ApexCharts */
        .chart-panel { width: 100%; }
        .chart-container {
            min-height: 250px;
        }

        .last-update {
            font-size: 0.8rem;
            color: #8b949e;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Estação Meteorológica</h1>
            <p>Monitoramento Leve para Pico W</p>
        </header>

        <div class="dashboard">
            <!-- PAINEL DE LEITURAS -->
            <div class="panel">
                <h2 class="panel-title">Leituras Atuais</h2>
                <div class="sensor-group">
                    <p class="sensor-group-title">Sensor 1 (AHT20)</p>
                    <div class="readings-grid">
                        <div class="reading-card">
                            <p class="label">Temperatura</p>
                            <p class="value" id="s1_temp">-- °C</p>
                        </div>
                        <div class="reading-card">
                            <p class="label">Umidade</p>
                            <p class="value" id="s1_humidity">-- %</p>
                        </div>
                    </div>
                </div>
                <div class="sensor-group">
                    <p class="sensor-group-title">Sensor 2 (BMP280)</p>
                    <div class="readings-grid">
                        <div class="reading-card">
                            <p class="label">Temperatura</p>
                            <p class="value" id="s2_temp">-- °C</p>
                        </div>
                        <div class="reading-card">
                            <p class="label">Pressão</p>
                            <p class="value" id="s2_pressure">-- Pa</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAINEL DE CONFIGURAÇÕES -->
            <div class="panel">
                <h2 class="panel-title">Configurações</h2>
                <form id="settingsForm">
                    <div class="form-group">
                        <label>Temperatura (°C)</label>
                        <div class="input-row">
                            <input type="number" id="temp_min" placeholder="Min" step="any">
                            <input type="number" id="temp_max" placeholder="Max" step="any">
                            <input type="number" id="temp_offset" placeholder="Offset" step="any">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Umidade (%)</label>
                        <div class="input-row">
                            <input type="number" id="humidity_min" placeholder="Min" step="any">
                            <input type="number" id="humidity_max" placeholder="Max" step="any">
                            <input type="number" id="humidity_offset" placeholder="Offset" step="any">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Pressão (Pa)</label>
                        <div class="input-row">
                            <input type="number" id="pressure_min" placeholder="Min" step="any">
                            <input type="number" id="pressure_max" placeholder="Max" step="any">
                            <input type="number" id="pressure_offset" placeholder="Offset" step="any">
                        </div>
                    </div>
                    <button type="submit" class="btn-submit">Salvar</button>
                    <div id="notification"></div>
                </form>
            </div>
            
            <!-- PAINÉIS DOS GRÁFICOS -->
            <div class="panel chart-panel">
                <h2 class="panel-title">Histórico de Temperatura</h2>
                <div id="tempChart" class="chart-container"></div>
            </div>
            <div class="panel chart-panel">
                <h2 class="panel-title">Histórico de Umidade</h2>
                <div id="humidityChart" class="chart-container"></div>
            </div>
            <div class="panel chart-panel">
                <h2 class="panel-title">Histórico de Pressão</h2>
                <div id="pressureChart" class="chart-container"></div>
            </div>
        </div>
        <p class="last-update" id="timestamp">Aguardando dados...</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const settingsForm = document.getElementById('settingsForm');
            const notification = document.getElementById('notification');
            let isUserEditingForm = false;
            let tempChart, humidityChart, pressureChart;

            // --- LÓGICA DO GRÁFICO APEXCHARTS ---
            const MAX_DATA_POINTS = 20;
            const chartData = {
                temp_s1: [], temp_s2: [], humidity_s1: [], pressure_s2: []
            };

            function createChart(selector, options) {
                const chart = new ApexCharts(document.querySelector(selector), options);
                chart.render();
                return chart;
            }

            function initCharts() {
                const commonOptions = {
                    chart: {
                        height: 250, type: 'line',
                        animations: { enabled: true, easing: 'linear', dynamicAnimation: { speed: 1000 } },
                        toolbar: { show: false }, zoom: { enabled: false }
                    },
                    stroke: { curve: 'smooth', width: 2 },
                    theme: { mode: 'dark' },
                    tooltip: { theme: 'dark' },
                    xaxis: {
                        type: 'datetime',
                        range: MAX_DATA_POINTS * 5000,
                        labels: { style: { colors: '#8b949e' } }
                    },
                    grid: { borderColor: '#30363d' },
                    legend: { labels: { colors: '#c9d1d9' } }
                };

                tempChart = createChart('#tempChart', {
                    ...commonOptions,
                    series: [{ name: 'Temp S1 (°C)', data: [] }, { name: 'Temp S2 (°C)', data: [] }],
                    yaxis: { title: { text: '°C', style: { color: '#8b949e' } }, labels: { style: { colors: '#8b949e' } } }
                });

                humidityChart = createChart('#humidityChart', {
                    ...commonOptions,
                    series: [{ name: 'Umidade S1 (%)', data: [] }],
                    yaxis: { min: 0, max: 100, title: { text: '%', style: { color: '#8b949e' } }, labels: { style: { colors: '#8b949e' } } }
                });

                pressureChart = createChart('#pressureChart', {
                    ...commonOptions,
                    series: [{ name: 'Pressão S2 (Pa)', data: [] }],
                    yaxis: { title: { text: 'Pa', style: { color: '#8b949e' } }, labels: { style: { colors: '#8b949e' } } }
                });
            }

            function updateCharts(data) {
                const timestamp = new Date().getTime();
                const pushData = (series, value) => {
                    series.push([timestamp, value]);
                    if (series.length > MAX_DATA_POINTS) series.shift();
                };
                
                pushData(chartData.temp_s1, getSafeNumber(data.aht20_temp));
                pushData(chartData.temp_s2, getSafeNumber(data.bmp280_temp));
                pushData(chartData.humidity_s1, getSafeNumber(data.aht20_humidity));
                pushData(chartData.pressure_s2, getSafeNumber(data.bmp280_pressure));

                tempChart.updateSeries([{ data: chartData.temp_s1 }, { data: chartData.temp_s2 }]);
                humidityChart.updateSeries([{ data: chartData.humidity_s1 }]);
                pressureChart.updateSeries([{ data: chartData.pressure_s2 }]);
            }

            // --- LÓGICA PRINCIPAL ---
            const getSafeNumber = (val) => (typeof val === 'number' && !isNaN(val)) ? val : 0;

            function updateReadings(data) {
                document.getElementById('s1_temp').textContent = `${getSafeNumber(data.aht20_temp).toFixed(1)} °C`;
                document.getElementById('s1_humidity').textContent = `${getSafeNumber(data.aht20_humidity).toFixed(1)} %`;
                document.getElementById('s2_temp').textContent = `${getSafeNumber(data.bmp280_temp).toFixed(1)} °C`;
                document.getElementById('s2_pressure').textContent = `${getSafeNumber(data.bmp280_pressure).toFixed(0)} Pa`;
            }

            function updateForm(config) {
                document.getElementById('temp_min').value = getSafeNumber(config.temp_min);
                document.getElementById('temp_max').value = getSafeNumber(config.temp_max);
                document.getElementById('temp_offset').value = getSafeNumber(config.temp_offset);
                document.getElementById('humidity_min').value = getSafeNumber(config.humidity_min);
                document.getElementById('humidity_max').value = getSafeNumber(config.humidity_max);
                document.getElementById('humidity_offset').value = getSafeNumber(config.humidity_offset);
                document.getElementById('pressure_min').value = getSafeNumber(config.pressure_min);
                document.getElementById('pressure_max').value = getSafeNumber(config.pressure_max);
                document.getElementById('pressure_offset').value = getSafeNumber(config.pressure_offset);
            }
            
            function showNotification(message, type) {
                notification.textContent = message;
                notification.className = type;
                notification.style.display = 'block';
                setTimeout(() => { notification.style.display = 'none'; }, 2000);
            }

            async function fetchData() {
                try {
                    const response = await fetch('/estado');
                    if (!response.ok) throw new Error(`Erro de rede: ${response.status}`);
                    const data = await response.json();
                    if (typeof data !== 'object' || data === null) throw new Error('Formato de dados inválido.');

                    updateReadings(data);
                    updateCharts(data);
                    if (!isUserEditingForm) {
                        updateForm(data);
                    }
                    document.getElementById('timestamp').textContent = 'Atualizado em: ' + new Date().toLocaleTimeString();
                } catch (error) {
                    console.error("Falha ao buscar dados:", error);
                    document.getElementById('timestamp').textContent = 'Erro de conexão. Tentando...';
                }
            }

            async function handleFormSubmit(event) {
                event.preventDefault();
                const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
                const formData = {
                    temp_min: getVal('temp_min'), temp_max: getVal('temp_max'), temp_offset: getVal('temp_offset'),
                    humidity_min: getVal('humidity_min'), humidity_max: getVal('humidity_max'), humidity_offset: getVal('humidity_offset'),
                    pressure_min: getVal('pressure_min'), pressure_max: getVal('pressure_max'), pressure_offset: getVal('pressure_offset')
                };

                try {
                    const response = await fetch('/limites', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData),
                    });
                    if (response.ok) {
                        showNotification('Salvo!', 'success');
                        isUserEditingForm = false;
                        await fetchData();
                    } else {
                        throw new Error(`Erro ao salvar: ${response.status}`);
                    }
                } catch (error) {
                    console.error("Falha ao enviar formulário:", error);
                    showNotification('Falha!', 'error');
                }
            }

            const formInputs = settingsForm.querySelectorAll('input');
            formInputs.forEach(input => {
                input.addEventListener('focus', () => { isUserEditingForm = true; });
                input.addEventListener('blur', () => { isUserEditingForm = false; });
            });

            // --- INICIALIZAÇÃO ---
            initCharts();
            settingsForm.addEventListener('submit', handleFormSubmit);
            fetchData();
            setInterval(fetchData, 5000);
        });
    </script>
</body>
</html>
